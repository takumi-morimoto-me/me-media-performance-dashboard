# 修正履歴

このドキュメントでは、プロジェクトで行われた重要な修正内容を記録します。

## 2025-09-17

### 動的ルーティング対応時のクライアント/サーバーコンポーネントエラー修正

**問題**
- `/media/[slug]`の動的ルーティングを実装した際に以下のエラーが発生
- エラー内容: "Attempted to call getMediaBySlug() from the server but getMediaBySlug is on the client"

**原因**
- `src/lib/media-service.ts`が`'use client'`ディレクティブを使用してクライアントサイドコンポーネントとして定義されていた
- サーバーサイドの`MediaPage`コンポーネントからクライアント関数を直接呼び出そうとしていた

**修正内容**
1. `src/lib/media-service.ts`から`'use client'`ディレクティブを削除
2. `src/components/shared/spreadsheet-grid.tsx`から存在しない`initializeExistingMedias`関数の参照を削除
3. TypeScriptエラー修正:
   - Kuroshiroライブラリのimportに`@ts-ignore`を追加
   - `updateData`の型を`Record<string, unknown>`から`Record<string, any>`に変更

**影響**
- `/media/[slug]`ページでサーバーサイドレンダリングが正常に動作
- 動的ルーティングによるメディア詳細ページが表示可能

**修正ファイル**
- `src/lib/media-service.ts`
- `src/components/shared/spreadsheet-grid.tsx`
- `src/app/media/[slug]/page.tsx` (既存)

### 階層化勘定項目実装と HTML 構造エラー修正

**問題**
- 勘定項目を大項目・小項目の階層構造に変更したい要望
- 階層化実装後にHTML構造エラーが発生: `<td> cannot be a child of <td>`

**実装内容**
1. 階層化された勘定項目の設計と実装:
   - `src/types/account-items.ts`: 型定義
   - `src/lib/account-service.ts`: 管理サービス
   - `src/components/settings/account-item-manager.tsx`: 設定画面UI
   - `src/components/shared/hierarchical-spreadsheet-grid.tsx`: 階層表示グリッド

2. HTML構造エラー修正:
   - `EditableCell`が既に`<td>`要素を返しているのに、さらに`<td>`で囲んでいた問題
   - `HierarchicalSpreadsheetGrid`で不要な`<td>`ラッパーを削除

**影響**
- 勘定項目を設定画面で一括管理可能
- スプレッドシートで階層構造を視覚的に表示
- HTML構造の正常化により hydration エラーを解消

**修正ファイル**
- `src/types/account-items.ts` (新規)
- `src/lib/account-service.ts` (新規)
- `src/components/settings/account-item-manager.tsx` (新規)
- `src/components/shared/hierarchical-spreadsheet-grid.tsx` (新規)
- `src/components/shared/budget-grid.tsx`
- `src/app/settings/page.tsx`

### 階層化勘定項目対応CSVインポート機能実装

**実装内容**
1. 階層化対応CSVインポートダイアログ:
   - `src/components/shared/csv-import-dialog.tsx`: 新形式・旧形式両対応のインポート機能
   - 項目マッピング確認とプレビュー機能
   - CSVテンプレートダウンロード機能

2. インポート機能の特徴:
   - **新形式対応**: `大項目, 小項目, 1月, 2月, ...` の階層CSV
   - **旧形式互換**: `項目, 1月, 2月, ...` の従来CSV
   - **自動マッピング**: 項目名の完全一致・部分一致による自動認識
   - **手動調整**: マッピングできない項目の手動選択
   - **インポート前プレビュー**: データ確認とマッピング状況の可視化

3. UX改善:
   - CSVテンプレート自動生成（現在の勘定項目構造に基づく）
   - エラー項目のハイライト表示
   - マッピング状況の可視化（Badge表示）
   - UTF-8 BOM対応によるExcel互換性

**影響**
- 既存CSVワークフローの完全保持
- 階層化による管理効率向上
- エクスポート形式の統一（大項目・小項目付き）

**修正ファイル**
- `src/components/shared/csv-import-dialog.tsx` (新規)
- `src/components/ui/badge.tsx` (新規)
- `src/components/ui/alert.tsx` (新規)
- `src/components/shared/hierarchical-spreadsheet-grid.tsx`

### CSVインポート時の勘定項目自動作成機能

**実装内容**
1. **自動項目作成システム**:
   - `src/lib/account-service.ts`: `createAccountItemsFromCSV()` 関数を追加
   - CSVに含まれる新しい項目を勘定項目設定に自動追加
   - カテゴリとアイテムの階層関係を保持した一括作成
   - 既存項目との重複チェック機能

2. **インテリジェントマッピング**:
   - `suggestAccountItemMapping()`: 高度な類似度計算による項目提案
   - カテゴリ名・項目名の完全一致・部分一致・単語レベル一致
   - スコアベースの類似項目ランキング

3. **ユーザー確認ダイアログ**:
   - `src/components/shared/new-items-confirmation-dialog.tsx`: 新項目作成前の確認UI
   - カテゴリ別グループ表示
   - 個別選択・一括選択機能
   - 新カテゴリ・新項目の視覚的区別

4. **シームレスなワークフロー**:
   - CSVインポート → 項目マッピング → 新項目確認 → 項目作成 → データインポート
   - 作成後の勘定項目リスト自動更新
   - エラーハンドリングとロールバック対応

**UX改善**
- **"新項目として作成"** バッジによる明確な状態表示
- 作成予定項目数の表示
- ワンクリックでの一括項目作成
- 既存ワークフローへの非侵入的な統合

**影響**
- CSVデータから勘定項目設定への自動反映
- 手動設定作業の大幅削減
- データの一貫性保証

**修正ファイル**
- `src/lib/account-service.ts`
- `src/components/shared/csv-import-dialog.tsx`
- `src/components/shared/new-items-confirmation-dialog.tsx` (新規)
- `src/components/ui/checkbox.tsx` (新規)
- `src/components/shared/hierarchical-spreadsheet-grid.tsx`