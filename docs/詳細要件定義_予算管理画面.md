# 詳細要件定義：予算管理画面

本文書は、「全体要件定義書」に基づき、予算管理画面に関する機能要件、UI/UX、および具体的な操作フローを詳細に定義するものである。

## 1. 画面概要

本画面は、ユーザーが各メディアの予算および主要KPIの目標値を、月次または日次単位で入力・編集・確認するための主要画面である。詳細な数値を入力するデータグリッドにより、効率的なデータ管理を実現する。

## 2. 機能要件

### 2.1. データ表示機能

- **メディア・期間選択**:
    - 画面上部に、操作対象となる「メディア」「会計期」「月」を選択するためのドロップダウンリストを配置する。
    - ユーザーの権限に基づき、選択可能なメディアのみをリストに表示する。

- **粒度切り替え**:
    - 表示・入力の粒度を「月次ビュー」と「日次ビュー」で切り替えるためのトグルスイッチを配置する。
    - この操作により、後述するトレンドグラフとデータグリッドの両方が一括で切り替わる。

- **トレンドグラフ表示**:
    - フィルターエリアの下、データグリッドの上部に、主要な勘定項目（例：売上高、PV数など）のトレンドを示す折れ線グラフを配置する。
    - **粒度連動**:
        - 「月次ビュー」選択時は、会計期（12ヶ月）の月次目標値の推移を表示する。
        - 「日次ビュー」選択時は、選択された月（1日〜31日）の日次目標値の推移を表示する。

- **データグリッド表示**:
    - 選択されたメディアと期間に基づき、Cloud Firestoreの`budgets`コレクションから予算データを取得し、グリッド形式で表示する。
    - **行**: 勘定項目（`budgetItems`マスターデータ）を階層構造で表示する。親項目は子項目の合計値を自動計算して表示する。
    - **列**:
        - 「月次ビュー」の場合: 会計期の12ヶ月分の月間合計値を表示する。
        - 「日次ビュー」の場合: 選択された月の日数分（1日〜31日）の日次目標値を表示する。
    - **前年同期比較**:
        - 各数値セルには、前年同期の予算額と比較した増減率（YoY）を補助情報として表示する。

### 2.2. データ編集機能

- **直接入力**:
    - グリッド内の入力可能なセル（子項目）をクリックすると、編集モードに切り替わり、数値を直接入力できる。
    - 数値入力後、セルからフォーカスが外れるか、Enterキーを押下したタイミングで、Cloud Firestoreへデータが自動保存される。

- **自動保存とステータス表示**:
    - 保存処理中はセルにインジケーターを表示し、保存が完了または失敗したことを視覚的にフィードバックする。

- **月次目標からの日次目標自動ブレークダウン**:
    - 「月次ビュー」で月間合計目標値を入力すると、その値を単純な日数で割り、対応する「日次ビュー」の各セルに自動的に反映させる機能を提供する。（例：月間目標31万円 → 日次目標1万円/日）
    - 逆に、「日次ビュー」で日次目標値を変更すると、その合計値が「月次ビュー」の月間合計目標値に自動で反映される。

### 2.3. データ管理支援機能

- **CSVインポート**:
    - 「月次ビュー」において、指定されたフォーマットのCSVファイルをアップロードすることで、1年分の月次予算データを一括でインポートする機能を提供する。

- **CSVエクスポート**:
    - 現在表示しているグリッドの内容をCSVファイルとしてダウンロードする機能を提供する。

- **勘定項目の管理**:
    - グリッドの行（勘定項目）に対して、その場で新しい項目（子項目）を追加したり、既存の項目名を編集したりするためのモーダルウィンドウを提供する。

## 3. UI/UXデザイン (shadcn/ui活用)

- **レイアウト**:
    - 画面上部に、`Card`コンポーネントを用いてメディアや期間を選択するフィルターエリアを配置する。
    - その直下に、トレンドグラフを表示するための`Card`を配置する。
    - データグリッドは、画面下部の主要部分を占めるテーブルで表現する。テーブルのヘッダーと最初の列（勘定項目名）は、スクロールしても追従する固定（sticky）レイアウトとする。

- **コンポーネント**:
    - フィルターエリア: `Select`コンポーネント（メディア・期間選択）、`Switch`コンポーネント（粒度切り替え）を使用する。
    - グラフ: (実装延期) `Charts`コンポーネントが現在の環境で利用できないため、一旦`Card`コンポーネントでプレースホルダーを配置する。`charts`が利用可能になり次第、折れ線グラフを実装する。
    - データグリッド: `Table`コンポーネントをベースに構築する。
    - 入力セル: `Input`コンポーネントを使用し、数値の3桁区切りカンマは自動で挿入する。
    - ボタン: `Button`コンポーネントをCSVインポート/エクスポートなどのアクションに使用する。
    - 通知: データの保存結果は `Sonner`コンポーネントを用いて画面の隅に短時間表示する。
    - モーダル: 勘定項目の追加・編集には`Dialog`コンポーネントを使用する。

- **インタラクション**:
    - データ読み込み中は、グラフとグリッドの両方に`Skeleton`コンポーネントを表示し、ローディング中であることを明示する。
    - 編集不可のセル（親項目など）は、視覚的に区別できるように背景色を変更し、クリックしても反応しないようにする。
    - 保存失敗時には、該当セルをハイライト表示し、ツールチップでエラー内容を確認できるようにする。

ップでエラー内容を確認できるようにする。
