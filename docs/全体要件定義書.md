# 全体要件定義書：メディア事業向け予実管理ダッシュボード

## 1. はじめに

本文書は、Webメディア事業の運営効率化とデータドリブンな意思決定を支援するために開発する、社内向け「予実管理ダッシュボード」の全体要件を定義するものである。

現在、事業のパフォーマンス指標（売上、費用、各種KPI）は、複数のASP（アフィリエイトサービスプロバイダ）や広告プラットフォーム、社内ツールに散在している。特に、APIを提供していないデータソースが多く、担当者が手動で数値を収集・集計する作業に多大な工数を要しており、データの鮮度と正確性の担保が困難になっている。

本プロジェクトは、これらのデータを一元的に集約し、可視化するWebアプリケーションを構築することを目的とする。特に、AIを活用した独自のデータ収集メカニズム「Model Context Protocol (MCP)」を導入し、手動作業を抜本的に削減することで、事業担当者が分析と戦略立案に集中できる環境を実現する。

## 2. プロジェクト目的とスコープ

### 2.1. 目的

- **データの一元化**: 散在する予実データを単一のデータベースに集約し、信頼できる唯一の情報源（Single Source of Truth）を構築する。
- **業務効率の向上**: AIを活用した実績データの自動収集により、手動でのデータ集計作業を原則ゼロにする。
- **意思決定の迅速化**: 全社およびメディア別のパフォーマンスをリアルタイムに近い鮮度で可視化し、迅速かつ的確な事業判断を支援する。
- **予実管理精度の向上**: 予算と実績の乖離を容易に把握できるUIを提供し、目標達成に向けたアクションを促進する。

### 2.2. 主要スコープ

本プロジェクトのスコープは、以下の4つの主要機能群の開発とする。

- **ダッシュボード機能**: 各種KPIの可視化
- **データ管理機能**: 予算・実績データおよびマスターデータのCRUD操作
- **実績データ自動収集機能 (MCP)**: 外部サイトからのデータ取得と格納
- **設定・管理機能**: ユーザー権限やシステム全体の動作設定

## 3. 機能要件

### 3.1. ダッシュボード機能

利用ユーザーが事業状況を直感的に把握するための閲覧機能。

- **サマリー表示**: 全社、およびメディア別の主要KPI（売上、費用、利益、PV数など）の当月着地見込み、予算、実績、達成率、前月比、前年同月比を一覧表示する。
- **時系列グラフ**: 主要KPIの推移を日次・月次・会計期単位で表示する折れ線グラフおよび棒グラフを提供する。
- **ドリルダウン分析**: メディア別、ASP別、勘定項目別など、複数の切り口でデータをフィルタリングし、深掘り分析ができる機能を提供する。

### 3.2. データ管理機能

ダッシュボードに表示する元データを管理するための機能。

- **予算入力**: メディアごと、勘定項目ごとに月次および日次の予算目標値を入力・更新できるスプレッドシート形式のUIを提供する。
- **実績修正**: 自動収集された実績値に修正が必要な場合、権限を持つユーザーが手動で値を上書きできる機能を提供する。
- **CSVインポート/エクスポート**: 予算・実績データをCSV形式で一括アップロード・ダウンロードできる機能を提供する。
- **マスターデータ管理**: 以下のマスターデータを登録・更新・削除できる管理画面を提供する。
    - ユーザーおよびロール（権限）
    - 管理対象メディア
    - 勘定項目（階層構造管理を含む）
    - 連携ASP情報

### 3.3. 実績データ自動収集機能 (Model Context Protocol - MCP)

本システムのコアとなる、外部サイトからの実績データ自動取得機能。

- **定期実行**: Cloud Schedulerにより、毎日定時にデータ収集プロセスを自動起動する。
- **ブラウザ自動操作**: Cloud Run上で実行されるプログラムが、ヘッドレスブラウザを用いて対象のASP管理画面へ自動でログインし、実績データが表示されているページへ遷移する。
- **AIによるデータ抽出**: 対象ページのHTMLコンテンツを取得し、Vertex AI (LLM) に送信する。AIがHTMLの構造ではなく文脈を理解し、あらかじめ定義された項目（例：「本日の確定収益」）に対応する数値を抽出する。
- **証憑の保管**: データ取得元のページ全体のスクリーンショットを撮影し、Firebase Storageに日付とメディア名がわかる形で保存する。
- **データベースへの書き込み**: 抽出した数値データと証憑画像の保存先URLをCloud Firestoreのresultsコレクションに書き込む。

## 4. 非機能要件

- **UI/UX**: 
    - **基本原則**: 「less is more」「simple is better」の考え方を採用し、不要な装飾を排したクリーンで直感的なデザインを目指す。
    - **レイアウト**: モダンなSPA（シングルページアプリケーション）としての操作性を提供する。主要な機能カテゴリ（ダッシュボード、データ管理など）はサイドバーに配置し、各機能内のサブカテゴリや操作はヘッダーに配置する。サイドバーとヘッダーは常に画面に固定され、コンテンツエリアのみがスクロールするレイアウトを採用する。
- **セキュリティ**:
    - ユーザー認証を必須とし、ロール（役割）に基づいた厳格なアクセス制御（RBAC）を行う。Firestoreセキュリティルールを用いて、ロールに応じたデータの読み取り・書き込み権限を強制する。
    - MCPが使用する外部サイトの認証情報は、Google Secret Managerを用いて安全に管理し、ソースコードには含めない。
- **パフォーマンス**: すべてのページの表示は原則3秒以内に完了することを目指す。Firestoreのデータ構造は、読み取りコストと応答速度を最適化する設計とする。
- **信頼性と監視**: MCPの実行が失敗した際には、Cloud Monitoringと連携し、指定された宛先（例：Slackチャンネル）へ即座にアラートを通知する。エラーログはCloud Loggingに集約し、後からの追跡調査を可能にする。
